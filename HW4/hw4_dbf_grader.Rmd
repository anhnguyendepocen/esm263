---
title: "ESM263 HW4 results data check"
author: "Casey O'Hara"
date: "1/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(DT)

### directory where assignments are saved
dir_asst <- 'hw4_check' 
### If you want to try this on your own .dbf file,
### change this to point to the folder where your .dbf is, then knit it
```

# Check my key against some student examples

Use `list.files` to identify all the .dbf files, including the full path.  Use `lapply` to quickly read in each one into a list.  We can use the `foreign::read.dbf()` function to read this format, instead of `readr::read_csv()`.

Once we have a list of data frames, then use `bind_rows` to combine all the list elements into one big data frame.  From the file names, we can extract the student names.

```{r}
dbfs <- list.files(dir_asst, pattern = '.dbf$',
                   full.names = TRUE, recursive = TRUE)
csvs <- list.files(dir_asst, pattern = '.csv$',
                   full.names = TRUE, recursive = TRUE)

dbf_df <- lapply(dbfs, FUN = function(f) {
  df <- foreign::read.dbf(f, as.is = TRUE) %>%
    janitor::clean_names() %>%
    mutate(file = basename(f))
  if('mean' %in% names(df)) df <- df %>% rename(score = mean)
  return(df)
}) %>%
  bind_rows()
csv_df <- lapply(csvs, FUN = function(f) {
  df <- read_csv(f, col_types = cols(CALWNUM = 'c')) %>%
    janitor::clean_names() %>%
    mutate(file = basename(f))
  if('mean' %in% names(df)) df <- df %>% rename(score = mean)
  return(df)
}) %>% bind_rows()

mdl_key <- foreign::read.dbf('keys/mdl_out.dbf') %>%
  mutate(method = 'full vals') %>%
  bind_rows(foreign::read.dbf('keys/mdl_out_view_01.dbf', as.is = TRUE) %>%
              mutate(method = 'vals 0 1')) %>%
  janitor::clean_names()
if('mean' %in% names(mdl_key)) mdl_key <- mdl_key %>% rename(key_score = mean)


scores_df <- dbf_df %>%
  bind_rows(csv_df) %>%
  mutate(score = round(score, 3)) %>%
  select(calwnum, score, file) %>%
  group_by(calwnum, score) %>%
  mutate(n_at_this_score = n()) %>%
  ungroup()

tol <- 0.01
check_df <- scores_df %>%
  left_join(mdl_key, by = 'calwnum') %>%
  mutate(correct = (abs(score - key_score) < tol)) %>%
  group_by(file, method) %>%
  summarize(n_correct = sum(correct),
            pct_correct = n_correct / n())

  # bind_rows() %>%
  # mutate(student = str_replace_all(file, 'HW2|.dbf$', ''),
  #          ### drops the prefix and extension
  #        first = str_extract(student, '[A-Z][a-z]*'),
  #          ### finds the first instance of capital followed by lower-case
  #        last  = str_replace(student, first, '')) %>%
  #          ### removes the first name from the full name to leave last name
  #          ### note: this helps for hyphenated or double last names...
  # select(-student)

DT::datatable(check_df)
```

# output checks

## Viewshed zone sums

```{r}
view_dbfs <- list.files('out_checks', pattern = 'view.+.dbf$',
                   full.names = TRUE, recursive = TRUE)
view_key <- foreign::read.dbf('keys/view_sums_out.dbf', as.is = TRUE) %>%
  mutate(method = 'full vals') %>%
  bind_rows(foreign::read.dbf('keys/view_sums_0_1_out.dbf', as.is = TRUE) %>%
              mutate(method = 'vals 0 1')) %>%
  janitor::clean_names() %>%
  select(calwnum, key_score = mean, method)

view_df <- lapply(view_dbfs, FUN = function(f) {
  df <- foreign::read.dbf(f, as.is = TRUE) %>%
    janitor::clean_names() %>%
    mutate(file = basename(f))
  if('mean' %in% names(df)) df <- df %>% rename(score = mean)
  return(df)
}) %>%
  bind_rows()


view_scores_df <- view_df %>%
  mutate(score = round(score, 3)) %>%
  select(calwnum, score, file) %>%
  group_by(calwnum, score) %>%
  mutate(n_at_this_score = n()) %>%
  ungroup()

view_tol <- 1
view_check_df <- view_scores_df %>%
  left_join(view_key, by = 'calwnum') %>%
  mutate(correct = (abs(score - key_score) <= view_tol)) %>%
  group_by(file, method) %>%
  summarize(n_correct = sum(correct),
            pct_correct = 100 * n_correct / n())


DT::datatable(view_check_df)
```

## Riparian zone sums

```{r}
rip_dbfs <- list.files('out_checks', pattern = 'rip.+.dbf$',
                   full.names = TRUE, recursive = TRUE)
rip_key <- foreign::read.dbf('keys/rip_sums_out.dbf', as.is = TRUE) %>%
  janitor::clean_names() %>%
  select(calwnum, key_score = mean)
rip_df <- lapply(rip_dbfs, FUN = function(f) {
  df <- foreign::read.dbf(f, as.is = TRUE) %>%
    janitor::clean_names() %>%
    mutate(file = basename(f))
  if('mean' %in% names(df)) df <- df %>% rename(score = mean)
  return(df)
}) %>%
  bind_rows()


rip_scores_df <- rip_df %>%
  mutate(score = round(score, 3)) %>%
  select(calwnum, score, file) %>%
  group_by(calwnum, score) %>%
  mutate(n_at_this_score = n()) %>%
  ungroup()

rip_tol <- 1
rip_check_df <- rip_scores_df %>%
  full_join(rip_key, by = 'calwnum') %>%
  mutate(correct = (abs(score - key_score) < rip_tol)) %>%
  group_by(file) %>%
  summarize(n_correct = sum(correct),
            pct_correct = 100 * n_correct / n())


DT::datatable(rip_check_df)
```


## Developable zone sums

```{r}
dev_dbfs <- list.files('out_checks', pattern = 'dev.+.dbf$',
                   full.names = TRUE, recursive = TRUE)
dev_key <- foreign::read.dbf('keys/dev_scores_out.dbf', as.is = TRUE) %>%
  janitor::clean_names() %>%
  select(calwnum, key_score = mean)
dev_df <- lapply(dev_dbfs, FUN = function(f) {
  df <- foreign::read.dbf(f, as.is = TRUE) %>%
    janitor::clean_names() %>%
    mutate(file = basename(f))
  if('mean' %in% names(df)) df <- df %>% rename(score = mean)
  return(df)
}) %>%
  bind_rows()


dev_scores_df <- dev_df %>%
  mutate(score = round(score, 3)) %>%
  select(calwnum, score, file) %>%
  group_by(calwnum, score) %>%
  mutate(n_at_this_score = n()) %>%
  ungroup()

dev_tol <- 0
dev_check_df <- dev_scores_df %>%
  full_join(dev_key, by = 'calwnum') %>%
  mutate(diff = abs(score - key_score),
         diff_pct = diff / key_score,
         correct = (diff <= dev_tol)) %>%
  group_by(file) %>%
  summarize(n_correct = sum(correct),
            pct_correct = 100 * n_correct / n())


DT::datatable(dev_check_df)
```
